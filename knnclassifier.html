<html>

<head>
  <!-- Load TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <!-- Load MobileNet -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
  <!-- Load KNN Classifier -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>
</head>

<body>
  <div>Did you give me a picture of Skye?</div>
  <div>
    <img id='class0' src='/skye_default.png' width=255px />
  </div>
  <div>
    <img id='test1' src='/test_set/notSkye_05.png' width=255px />
  </div>
  <div id='result'></div>
</body>
<!-- Place your code in the script tag below. You can also use an external .js file -->
<script>
  // MOBILENET
  const mobileNetApp = async function (str) {
    const mobilenetModule = await mobilenet.load();
    const img = document.getElementById(str)
    const predictions = await mobilenetModule.classify(img)
    console.log('Predictions: ', predictions)
  }

  mobileNetApp('class0')
  mobileNetApp('test1')




  // `                        KNNCLASSIFIER
  const imagesArray = (base, fileCount, fileType) => {
    const cache = [];
    let img;
    for (let j = 0; j < fileCount; j++) {
      img = new Image();
      if (j > 9) { // assuming, for simplicity's sake, that any dataset I feed it will not exceed 100 images :)
        img.src = base.slice(0, -1) + j + '.' + fileType;
      } else {
        img.src = base + j + '.' + fileType;
      }
      cache.push(img)
    }
    return cache
  }
  const skyeImages = imagesArray('/skye_training/skye_00', 7, 'png')
  const catImages = imagesArray('/cats/cat_000', 10, 'jpg')

  const init = async function () {
    // Create the classifier.
    const classifier = knnClassifier.create();

    // Load mobilenet.
    const mobilenetModule = await mobilenet.load();

    // Add MobileNet activations to the model repeatedly for all classes.

    // train the model on Skye
    for (let i = 0; i < skyeImages.length; i++) {
      const image = skyeImages[i]
      const img = tf.browser.fromPixels(image);
      const logits = mobilenetModule.infer(img, 'conv_preds');
      classifier.addExample(logits, 'Skye');
    }

    // train the model on cats that aren't Skye
    for (let i = 0; i < catImages.length; i++) {
      const image = catImages[i]
      const img = tf.browser.fromPixels(image);
      const logits = mobilenetModule.infer(img, 'conv_preds');
      classifier.addExample(logits, 'An impostor')
    }

    // Make a prediction.
    const x = tf.browser.fromPixels(document.getElementById('test1'));
    const xlogits = mobilenetModule.infer(x, 'conv_preds');
    const result1 = await classifier.predictClass(xlogits);
    const resultObj = document.getElementById('result')
    if (result1.label === 'Skye') {
      resultObj.innerText = 'This is a picture of Skye!'
    } else {
      resultObj.innerText = "This is an impostor!"
    }
  }

  init();

</script>

</html>
